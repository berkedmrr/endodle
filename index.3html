<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Endodle â€” Daily Endoscopy Puzzle</title>
  <style>
    /* Enhanced EndoTumordle: Medical puzzle game with improved graphics and playability */
    :root{
      --bg:#0a0f1c; --card-bg:#0f1420; --muted:#a8b3c7; --accent:#00d4ff; --accent-2:#7c3aed;
      --glass: rgba(255,255,255,0.05); --success:#10b981; --warn:#f59e0b; --danger:#ef4444; --radius:16px;
      --max-w:920px; font-family: Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      --shadow: 0 20px 60px rgba(0,0,0,0.4); --shadow-lg: 0 25px 80px rgba(0,0,0,0.5);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:radial-gradient(1400px 700px at 15% 15%, rgba(124,58,237,0.12), transparent),radial-gradient(800px 400px at 85% 85%, rgba(0,212,255,0.08), transparent),linear-gradient(180deg,var(--bg),#05101a);color:#e6eef6;-webkit-font-smoothing:antialiased}
    
    /* Loldle-like subtle grid background */
    body::before{content:"";position:fixed;inset:0;background-image:linear-gradient(rgba(255,255,255,0.06) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.06) 1px, transparent 1px);background-size:48px 48px, 48px 48px;mask-image:radial-gradient(ellipse at center, black 40%, transparent 70%);opacity:0.06;pointer-events:none;z-index:0}
    body::after{content:"";position:fixed;inset:-10% -10% auto -10%;height:60%;background:radial-gradient(600px 300px at 15% 10%, rgba(124,58,237,0.22), transparent), radial-gradient(500px 250px at 85% 20%, rgba(0,212,255,0.18), transparent);filter:blur(30px);opacity:0.6;pointer-events:none;z-index:0}

    /* Optional custom background hook */
    .user-bg{position:fixed;inset:0;background-position:center;background-size:cover;background-repeat:no-repeat;z-index:0;opacity:0.25}

    /* Enhanced center layout with better visual hierarchy */
    .container{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;position:relative}
    .game{width:100%;max-width:820px;background:linear-gradient(145deg, rgba(255,255,255,0.05), rgba(255,255,255,0.015));border-radius:24px;padding:0 32px 32px 32px;box-shadow:var(--shadow-lg),inset 0 1px 0 rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.08);backdrop-filter:blur(20px);position:relative;overflow:hidden}
    .game::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent)}

    /* Enhanced header with better visual impact */
    .header{display:flex;align-items:center;justify-content:center;text-align:center;gap:12px;margin-bottom:12px;position:relative;z-index:2;padding:18px 0;border-bottom:1px solid rgba(255,255,255,0.06)}
    .logo{width:64px;height:64px;border-radius:16px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:900;font-size:28px;box-shadow:0 12px 40px rgba(0,212,255,0.2),inset 0 1px 0 rgba(255,255,255,0.2);position:relative;animation:logoGlow 3s ease-in-out infinite alternate}
    .logo::before{content:'';position:absolute;inset:-2px;border-radius:22px;background:linear-gradient(135deg,var(--accent),var(--accent-2));opacity:0.3;filter:blur(8px);z-index:-1}
    h1{margin:0;font-size:26px;letter-spacing:0.8px;font-weight:900;background:linear-gradient(135deg,#ffffff,var(--muted));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    /* Animated title effects */
    .title-animated{background:linear-gradient(90deg,#fff 0%, #c7d2fe 20%, #60a5fa 40%, #a78bfa 60%, #22d3ee 80%, #fff 100%);background-size:200% auto;-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;text-shadow:0 0 18px rgba(34,211,238,0.15), 0 0 42px rgba(124,58,237,0.12);animation:titleShine 6s linear infinite, titleGlow 3s ease-in-out infinite alternate}
    .title-animated::after{content:"";display:block;height:3px;margin:8px auto 0 auto;width:48px;border-radius:999px;background:linear-gradient(90deg,transparent, rgba(255,255,255,0.8), transparent);filter:blur(0.5px);animation:underlineSweep 2.8s ease-in-out infinite}
    @keyframes titleShine{0%{background-position:0% center}100%{background-position:200% center}}
    @keyframes titleGlow{0%{text-shadow:0 0 10px rgba(34,211,238,0.12), 0 0 24px rgba(124,58,237,0.1);transform:translateY(0)}100%{text-shadow:0 0 18px rgba(34,211,238,0.28), 0 0 48px rgba(124,58,237,0.22);transform:translateY(-0.5px)}}
    @keyframes underlineSweep{0%,100%{width:48px;opacity:0.65}50%{width:120px;opacity:1}}
    .title-pop{animation:titlePopIn 600ms cubic-bezier(.2,.8,.2,1) both}
    @keyframes titlePopIn{from{opacity:0;transform:translateY(8px) scale(0.98)}to{opacity:1;transform:translateY(0) scale(1)}}
    /* Loldle-like mode tabs */
    .mode-tabs{display:flex;gap:10px;align-items:center;margin:0 0 18px 0;padding-top:12px;position:relative;z-index:2}
    .tab{padding:10px 14px;border-radius:999px;font-size:13px;font-weight:800;letter-spacing:.2px;background:linear-gradient(145deg,rgba(255,255,255,0.08),rgba(255,255,255,0.03));border:1px solid rgba(255,255,255,0.08);color:#dfe7f1;cursor:pointer;transition:all .2s ease}
    .tab:hover{transform:translateY(-1px);background:linear-gradient(145deg,rgba(255,255,255,0.12),rgba(255,255,255,0.06))}
    .tab.active{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#000;box-shadow:0 8px 24px rgba(0,212,255,0.2)}
    p.lead{margin:4px 0 0;color:var(--muted);font-size:14px;opacity:0.9}

    /* Enhanced top status row with better visual hierarchy */
    .top-row{display:flex;gap:12px;align-items:center;margin-bottom:20px;flex-wrap:wrap}
    .stat{background:linear-gradient(145deg,rgba(255,255,255,0.06),rgba(255,255,255,0.02));padding:10px 14px;border-radius:12px;font-size:13px;color:var(--muted);border:1px solid rgba(255,255,255,0.05);backdrop-filter:blur(10px);font-weight:500;transition:all 0.2s ease}
    .stat:hover{background:linear-gradient(145deg,rgba(255,255,255,0.08),rgba(255,255,255,0.04));transform:translateY(-1px)}
    .stat .ico{width:16px;height:16px;margin-right:8px;vertical-align:-3px;opacity:0.9}

    /* Enhanced main split with better spacing */
    .play-area{display:grid;grid-template-columns:1fr 280px;gap:24px;position:relative;z-index:1}
    @media (max-width:900px){.play-area{grid-template-columns:1fr;gap:20px}}

    /* Enhanced central column with better visual hierarchy */
    .center{display:flex;flex-direction:column;gap:16px;position:relative;z-index:2}
    .tiles{display:flex;flex-wrap:wrap;gap:10px}
    .chip{background:linear-gradient(145deg,rgba(255,255,255,0.08),rgba(255,255,255,0.03));padding:12px 16px;border-radius:12px;font-size:13px;color:var(--muted);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,0.05);font-weight:500;transition:all 0.2s ease;position:relative}
    .chip:hover{background:linear-gradient(145deg,rgba(255,255,255,0.12),rgba(255,255,255,0.06));transform:translateY(-1px)}

    .input-panel{background:linear-gradient(145deg,rgba(255,255,255,0.06),rgba(255,255,255,0.02));padding:20px;border-radius:16px;border:1px solid rgba(255,255,255,0.08);backdrop-filter:blur(12px);position:relative;z-index:1}
    .input-panel::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.1),transparent)}
    .big-input{display:flex;gap:12px;align-items:stretch}
    input[type=text]{flex:1;padding:18px 20px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);background:linear-gradient(145deg,rgba(0,0,0,0.25),rgba(0,0,0,0.12));color:inherit;font-size:17px;font-weight:600;transition:all 0.2s ease;backdrop-filter:blur(8px)}
    input[type=text]:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(0,212,255,0.1);background:linear-gradient(145deg,rgba(0,0,0,0.3),rgba(0,0,0,0.2))}
    .btn{border:none;padding:14px 18px;border-radius:12px;font-weight:800;cursor:pointer;transition:all 0.2s ease;position:relative;overflow:hidden;font-size:15px;letter-spacing:.2px}
    .btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.1),transparent);transition:left 0.5s ease}
    .btn:hover::before{left:100%}
    .btn-primary{background:linear-gradient(135deg,var(--accent),var(--accent-2));box-shadow:0 8px 25px rgba(0,212,255,0.2);color:#000;font-weight:800}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 12px 35px rgba(0,212,255,0.3)}
    .btn-ghost{background:linear-gradient(145deg,rgba(255,255,255,0.08),rgba(255,255,255,0.03));border:1px solid rgba(255,255,255,0.1);color:var(--muted);backdrop-filter:blur(8px)}
    .btn-ghost:hover{background:linear-gradient(145deg,rgba(255,255,255,0.12),rgba(255,255,255,0.06));transform:translateY(-1px)}

    .hint-small{color:var(--muted);font-size:13px}

    /* Enhanced guesses with better visual feedback */
    .guesses{display:flex;flex-direction:column;gap:12px;position:relative;z-index:3;max-height:360px;overflow:auto;padding-right:4px}
    .guess-card{display:flex;gap:8px;align-items:center;background:linear-gradient(145deg,rgba(255,255,255,0.06),rgba(255,255,255,0.02));border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,0.08);backdrop-filter:blur(8px);transition:all 0.3s ease;position:relative;overflow:hidden}
    .guess-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.1),transparent)}
    .guess-card:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,0.1)}
    .guess-name{font-weight:800;font-size:15px;color:#ffffff}
    .badges{display:flex;gap:8px;flex-wrap:wrap}
    .badge{padding:8px 12px;border-radius:8px;font-size:12px;font-weight:600;transition:all 0.2s ease;position:relative;overflow:hidden}
    .badge::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent);transition:left 0.3s ease}
    .badge:hover::before{left:100%}
    .ok{background:linear-gradient(135deg,var(--success),#059669);color:#ffffff;box-shadow:0 4px 15px rgba(16,185,129,0.2)}
    .partial{background:linear-gradient(135deg,var(--warn),#d97706);color:#ffffff;box-shadow:0 4px 15px rgba(245,158,11,0.2)}
    .no{background:linear-gradient(145deg,rgba(255,255,255,0.08),rgba(255,255,255,0.03));color:var(--muted);border:1px solid rgba(255,255,255,0.05)}

    /* Enhanced right column panels */
    .right{display:flex;flex-direction:column;gap:16px}
    .panel{background:linear-gradient(145deg,rgba(255,255,255,0.06),rgba(255,255,255,0.02));padding:16px;border-radius:16px;border:1px solid rgba(255,255,255,0.08);backdrop-filter:blur(12px);position:relative;transition:all 0.2s ease}
    .panel::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.1),transparent)}
    .panel:hover{transform:translateY(-1px);box-shadow:0 8px 25px rgba(0,0,0,0.1)}
    .panel h3{margin:0 0 12px 0;font-size:16px;font-weight:700;color:#ffffff}

    footer{margin-top:20px;color:var(--muted);font-size:12px;text-align:center;opacity:0.8}

    /* Decorative SVG noise overlay for texture */
    .noise{position:fixed;inset:0;pointer-events:none;z-index:1;opacity:0.05;mix-blend-mode:overlay}
    .noise canvas{width:100%;height:100%}

    /* Enhanced suggestion list */
    .suggestions{position:relative}
    .suggest-list{position:absolute;left:0;right:0;top:60px;background:linear-gradient(145deg,rgba(0,0,0,0.9),rgba(0,0,0,0.8));border:1px solid rgba(255,255,255,0.1);border-radius:12px;max-height:280px;overflow:auto;z-index:60;padding:8px;backdrop-filter:blur(20px);box-shadow:0 20px 60px rgba(0,0,0,0.5)}
    .suggest-item{padding:12px 16px;border-radius:8px;cursor:pointer;font-size:14px;transition:all 0.2s ease;border:1px solid transparent}
    .suggest-item:hover{background:linear-gradient(145deg,rgba(255,255,255,0.1),rgba(255,255,255,0.05));border-color:rgba(255,255,255,0.1);transform:translateX(4px)}

    /* Enhanced animations and visual effects */
    .fade-in{animation:fadeIn .6s ease both}
    @keyframes fadeIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}
    
    @keyframes logoGlow{0%{box-shadow:0 12px 40px rgba(0,212,255,0.2),inset 0 1px 0 rgba(255,255,255,0.2)}100%{box-shadow:0 12px 40px rgba(0,212,255,0.4),inset 0 1px 0 rgba(255,255,255,0.3)}}
    
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.7}}
    .pulse{animation:pulse 2s ease-in-out infinite}
    
    @keyframes slideIn{from{opacity:0;transform:translateX(-20px)}to{opacity:1;transform:translateX(0)}}
    .slide-in{animation:slideIn 0.4s ease both}
    
    @keyframes bounce{0%,20%,50%,80%,100%{transform:translateY(0)}40%{transform:translateY(-4px)}60%{transform:translateY(-2px)}}
    .bounce{animation:bounce 0.6s ease}
    
    /* Progress indicator */
    .progress-bar{width:100%;height:4px;background:rgba(255,255,255,0.1);border-radius:2px;overflow:hidden;margin:8px 0}
    .progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));border-radius:2px;transition:width 0.3s ease}
    
    /* Success/Error states */
    .success-glow{box-shadow:0 0 20px rgba(16,185,129,0.3) !important}
    .error-shake{animation:shake 0.5s ease-in-out}
    @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}
    
    /* Enhanced mobile responsiveness */
    @media (max-width:768px){
      .container{padding:16px}
      .game{padding:20px;border-radius:20px;padding-bottom:calc(20px + env(safe-area-inset-bottom))}
      .header{gap:16px;margin-bottom:14px}
      .logo{width:64px;height:64px;font-size:24px}
      h1{font-size:24px}
      .top-row{gap:8px;margin-bottom:10px}
      .stat{padding:8px 12px;font-size:12px}
      .play-area{gap:12px}
      .big-input{flex-direction:column;gap:8px}
      .btn{padding:14px 18px;font-size:16px}
      .guess-card{flex-direction:column;align-items:flex-start;gap:12px}
      .badges{gap:6px}
      .badge{padding:6px 10px;font-size:11px}
      .panel{padding:12px}
      .suggest-list{max-height:200px}
      /* Sticky input at bottom for easier play */
      .input-panel{position:sticky;bottom:calc(env(safe-area-inset-bottom) + 8px);z-index:20}
      /* Make guesses scroll well on small screens */
      .guesses{max-height:50vh;overflow:auto;padding-right:6px}
      /* Reduce heavy effects on mobile */
      .noise{display:none}
    }
    
    @media (max-width:480px){
      .container{padding:12px}
      .game{padding:16px}
      .header{flex-direction:column;text-align:center;gap:10px}
      .logo{width:56px;height:56px;font-size:20px}
      h1{font-size:20px}
      .top-row{justify-content:center}
      .stat{padding:6px 10px;font-size:11px}
      .input-panel{padding:16px}
      .big-input{gap:10px}
      .btn{padding:14px 18px;font-size:16px}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="game">
      <!-- Drop your background file in the project and set its path below -->
      <div id="userBg" class="user-bg" style="display:none"></div>
      <div class="header">
        <div>
          <h1 class="title-animated title-pop">ENDODLE</h1>
          <p class="lead">Daily endoscopy puzzle â€” one lesion to guess, multiple clues. Autocomplete helps.</p>
        </div>
      </div>

      <div class="mode-tabs">
        <button class="tab active" data-mode="classic">Classic</button>
      </div>

      <div class="top-row">
        <div class="stat" id="dateLabel"><svg class="ico" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M7 2a1 1 0 0 1 1 1v1h8V3a1 1 0 1 1 2 0v1h1a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1V3a1 1 0 0 1 1-1Zm12 8H5v8a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-8Z"/></svg>Date</div>
        <div style="flex:1"></div>
        <div class="stat" id="attemptsStat"><svg class="ico" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2Zm1 5a1 1 0 1 0-2 0v5.382l3.447 2.06a1 1 0 0 0 1.006-1.732L13 11.618V7Z"/></svg>Attempts: 0/6</div>
        <div class="stat" id="streakStat"><svg class="ico" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 2 9 9H2l5.5 4-2.5 7 7-4.5 7 4.5-2.5-7L22 9h-7L12 2Z"/></svg>Streak: 0</div>
        <div class="stat" id="bestStat"><svg class="ico" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M17 3H7a2 2 0 0 0-2 2v11.5A2.5 2.5 0 0 0 7.5 19h9A2.5 2.5 0 0 0 19 16.5V5a2 2 0 0 0-2-2Zm-2 6H9a1 1 0 1 1 0-2h6a1 1 0 1 1 0 2Zm0 4H9a1 1 0 1 1 0-2h6a1 1 0 1 1 0 2Z"/></svg>Best: 0</div>
      </div>

      <!-- Custom background area below; you can add your own image -->
      <div id="customBackgroundSlot" style="height:0"></div>

      <div class="play-area">
        <div class="center">
          <div class="panel">
            <div class="tiles" id="clueChips" aria-live="polite"></div>
          </div>

          <div class="input-panel fade-in">
            <div style="font-weight:800;margin-bottom:12px;font-size:16px">Make your guess</div>
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill" style="width:0%"></div>
            </div>
            <div class="big-input">
              <div style="flex:1;position:relative" class="suggestions">
                <input id="guessInput" type="text" placeholder="Type lesion name (autocomplete will help)..." autocomplete="off" />
                <div class="suggest-list" id="suggestList" style="display:none"></div>
              </div>
              <button id="guessBtn" class="btn btn-primary">Guess</button>
              <button id="revealBtn" class="btn btn-ghost">Reveal</button>
            </div>
            <div class="hint-small" style="margin-top:12px">Tip: choose a suggestion to autofill. Press Enter to submit.</div>
          </div>

          <div class="panel">
            <div style="font-weight:800;margin-bottom:8px">Your attempts</div>
            <div class="guesses" id="guesses" aria-live="polite"></div>
          </div>
        </div>

        <aside class="right">
          <div class="panel">
            <h3>Today's answer</h3>
            <div id="answerReveal" class="hint-small">Hidden until revealed or solved.</div>
          </div>

          <div class="panel">
            <h3>How to use feedback</h3>
            <div class="hint-small">
              <ul style="margin:0;padding-left:18px;color:var(--muted)">
                <li><strong>Green</strong> = exact match</li>
                <li><strong>Amber</strong> = partial/close</li>
                <li><strong>Gray</strong> = not matching</li>
              </ul>
            </div>
          </div>

          <div class="panel">
            <h3>Progress</h3>
            <div id="progressText" class="hint-small">Play daily to build streaks.</div>
          </div>
        </aside>
      </div>

      <footer>Educational demo â€” not for clinical decision-making.</footer>
    </div>
  </div>

  <!-- Background emblems removed; add your own background image or SVG. -->

  <!-- Subtle animated noise overlay -->
  <div class="noise" aria-hidden="true">
    <canvas id="noiseCanvas"></canvas>
  </div>

<script>
// --- Original game logic preserved, only styling/markup changed above to mimic loldle visuals ---

const ITEMS = [
  {key:'gastric_adenoca', name:'Gastric adenocarcinoma', organ:'Stomach', malign:true, morph:'Ulcerative / Infiltrative', color:'Erythematous', location:'Antrum (distal)', growth:'Ulcerated', size:'large (>3cm)', symptom:'Bleeding', note:'Most common gastric malignancy; often presents with weight loss or GI bleeding.'},
  {key:'gastric_gist', name:'Gastrointestinal stromal tumor (GIST)', organ:'Stomach', malign:true, morph:'Submucosal / Polypoid', color:'Pale', location:'Body / Fundus', growth:'Submucosal bulge', size:'variable', symptom:'Incidental/bleeding', note:'Mesenchymal tumor: EUS helpful; c-KIT mutation.'},
  {key:'gastric_hyperplastic', name:'Gastric hyperplastic polyp', organ:'Stomach', malign:false, morph:'Polypoid', color:'Red/erythematous', location:'Antrum', growth:'Polypoid', size:'small', symptom:'Asymptomatic', note:'Often associated with chronic gastritis; low malignant potential.'},
  {key:'gastric_lymphoma', name:'Gastric lymphoma (MALT/High-grade)', organ:'Stomach', malign:true, morph:'Diffuse / Nodular', color:'Pale/edematous', location:'Any', growth:'Diffuse thickening', size:'variable', symptom:'Early satiety/weight loss', note:'May mimic gastritis; H. pylori-associated MALT.'},
  {key:'barrett_adenoca', name:'Barrett-related esophageal adenocarcinoma', organ:'Esophagus', malign:true, morph:'Nodular / Ulcerative', color:'Erythematous', location:'Distal esophagus', growth:'Nodular', size:'medium', symptom:'Reflux/dysphagia', note:'Arises in Barrett mucosa; surveillance is important.'},
  {key:'esoph_scc', name:'Esophageal squamous cell carcinoma', organ:'Esophagus', malign:true, morph:'Infiltrative / Stenosing', color:'Pale/Whitish', location:'Mid esophagus', growth:'Infiltrative', size:'medium/large', symptom:'Progressive dysphagia', note:'Risk factors: smoking, alcohol.'},
  {key:'colorectal_adenoma', name:'Colorectal adenomatous polyp', organ:'Colon', malign:false, morph:'Polypoid (tubular/villous)', color:'Pale/whitish', location:'Any colon segment', growth:'Polypoid', size:'small-medium', symptom:'Asymptomatic/bleeding', note:'Dysplasia potential; remove upon detection.'},
  {key:'colorectal_adenoca', name:'Colorectal adenocarcinoma', organ:'Colon', malign:true, morph:'Infiltrative / Ulcerative / Annular', color:'Erythematous/irregular', location:'Rectum/Sigmoid common', growth:'Annular/infiltrative', size:'variable', symptom:'Bleeding/obstruction', note:'Common GI malignancy; screening reduces incidence.'},
  {key:'colorectal_lipoma', name:'Colonic lipoma', organ:'Colon', malign:false, morph:'Submucosal / Cushion sign', color:'Pale/yellowish', location:'Any', growth:'Submucosal', size:'small-medium', symptom:'Usually asymptomatic', note:'Soft, compressible submucosal lesion.'},
  {key:'duodenal_adenoma', name:'Duodenal adenomatous polyp', organ:'Duodenum', malign:false, morph:'Polypoid', color:'Pale', location:'Periampullary region', growth:'Polypoid', size:'small', symptom:'Asymptomatic', note:'Can be premalignant; ampullary lesions important.'},
  {key:'small_bowel_net', name:'Small bowel neuroendocrine tumor (NET)', organ:'Small intestine', malign:true, morph:'Submucosal nodular/polypoid', color:'Yellowish', location:'Ileum/Jejunum', growth:'Nodular', size:'small', symptom:'Obstruction/carcinoid sx', note:'May secrete serotonin; may present with bowel obstruction.'},
  {key:'pancreatic_cystic_neoplasm', name:'Pancreatic cystic neoplasm (EUS-visible)', organ:'Pancreas', malign:true, morph:'Cystic', color:'Clear/complex', location:'Head/Body/Tail', growth:'Cystic', size:'variable', symptom:'Often incidental', note:'Requires EUS-FNA for cyst fluid analysis.'},
  {key:'gallbladder_polyp', name:'Gallbladder polyp (neoplastic)', organ:'Gallbladder', malign:true, morph:'Polypoid', color:'Pale', location:'Fundus', growth:'Polypoid', size:'small', symptom:'Usually asymptomatic', note:'Polyps >1cm raise concern for neoplasm.'},
  {key:'esoph_varix', name:'Esophageal varix', organ:'Esophagus', malign:false, morph:'Vascular / Tortuous', color:'Red/blue', location:'Lower esophagus', growth:'Vascular', size:'variable', symptom:'Bleeding', note:'Portal hypertension sign; high bleeding risk.'},
  {key:'gastic_peptic_ulcer', name:'Peptic ulcer with scarring', organ:'Stomach', malign:false, morph:'Ulcerative', color:'Erythematous/clean base', location:'Antrum/duodenal bulb', growth:'Ulcer', size:'variable', symptom:'Pain/bleeding', note:'Benign peptic disease vs malignant ulcer requires biopsy.'},
  {key:'anal_squamous_carcinoma', name:'Anal squamous cell carcinoma', organ:'Anus', malign:true, morph:'Ulcerated/nodular', color:'Erythematous', location:'Anal canal', growth:'Nodular', size:'variable', symptom:'Bleeding/pain', note:'HPV-related in many cases.'},
  {key:'gastric_polyp_fundic', name:'Fundic gland polyp', organ:'Stomach', malign:false, morph:'Polypoid', color:'Pale/whitish', location:'Fundus', growth:'Polypoid', size:'small', symptom:'Asymptomatic', note:'Often benign; associated with PPI use.'},
  {key:'oesophageal_benign_stricture', name:'Benign esophageal stricture', organ:'Esophagus', malign:false, morph:'Stenosing/Scar', color:'Normal', location:'Lower esophagus', growth:'Fibrotic', size:'narrowing', symptom:'Dysphagia', note:'Causes include reflux, caustic injury.'},
  {key:'gastric_mets', name:'Gastric metastasis (breast/lung/melanoma)', organ:'Stomach', malign:true, morph:'Submucosal/nodular', color:'Varied', location:'Any', growth:'Nodular', size:'variable', symptom:'Bleeding/obstruction', note:'Secondary; endoscopic appearance variable.'},
  {key:'barrett_dysplasia', name:'Barrett high-grade dysplasia', organ:'Esophagus', malign:false, morph:'Flat/nodular dysplasia', color:'Erythematous', location:'Distal esophagus', growth:'Flat/nodular', size:'small', symptom:'Often asymptomatic', note:'Premalignant stage requiring intervention.'},
  {key:'ileocecal_tb', name:'Ileocecal tuberculosis (endoscopic mimic)', organ:'Ileocaecal region', malign:false, morph:'Ulcerative/nodular', color:'Erythematous', location:'Ileocecal valve', growth:'Ulcerative', size:'variable', symptom:'Pain/fever', note:'Infectious/inflammatory mimic of malignancy.'},
  {key:'colitis_related_pseudopolyps', name:'Pseudopolyps (IBD)', organ:'Colon', malign:false, morph:'Polypoid/Inflammatory', color:'Erythematous', location:'Any', growth:'Polypoid', size:'variable', symptom:'Diarrhea/bleeding', note:'Inflammation-related, not neoplastic.'},
  {key:'ampullary_carcinoma', name:'Ampullary carcinoma', organ:'Duodenum/Ampulla', malign:true, morph:'Nodular/polypoid', color:'Erythematous', location:'Ampulla', growth:'Nodular', size:'small-medium', symptom:'Obstructive jaundice', note:'Presents with biliary obstruction symptoms.'},
  {key:'submucosal_schwannoma', name:'Submucosal schwannoma', organ:'GI tract', malign:false, morph:'Submucosal', color:'Pale', location:'Any', growth:'Submucosal nodule', size:'small', symptom:'Often incidental', note:'Benign nerve-sheath tumor.'},
  {key:'h_pylori_gastritis', name:'H. pylori associated gastritis', organ:'Stomach', malign:false, morph:'Erythematous/mucosal', color:'Erythematous', location:'Antrum/body', growth:'Diffuse', size:'n/a', symptom:'Dyspepsia', note:'Treatable infectious etiology.'},
  {key:'jejunal_adenoca', name:'Small bowel adenocarcinoma (jejunum)', organ:'Small intestine', malign:true, morph:'Ulcerative/nodular', color:'Erythematous', location:'Jejunum', growth:'Infiltrative', size:'variable', symptom:'Obstruction/bleeding', note:'Rare; often diagnosed late.'},
  {key:'mucosa_associated_erosion', name:'Mucosal erosion (non-specific)', organ:'GI tract', malign:false, morph:'Erosive', color:'Red', location:'Any', growth:'Erosion', size:'small', symptom:'Occasional bleeding', note:'Non-specific, often benign.'}
];

// --- Utilities ---
function normalize(s){return (s||'').toString().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').trim();}
function fuzzyMatch(term, text){
  const t = normalize(term); const txt = normalize(text);
  if(!t) return false;
  if(txt.includes(t)) return true;
  const toks = t.split(' ');
  return toks.every(tok => txt.includes(tok));
}

function dailyIndex(date=new Date()){const start=new Date(2024,0,1);const days=Math.floor((Date.UTC(date.getFullYear(),date.getMonth(),date.getDate())-Date.UTC(start.getFullYear(),start.getMonth(),start.getDate()))/(24*3600*1000));return Math.abs(days)%ITEMS.length;}

const today = new Date();
const TARGET = ITEMS[dailyIndex(today)];

let attempts = 0; const MAX = 6; let solved=false;
const statsKey = 'endodle_stats_v1';
let stats = JSON.parse(localStorage.getItem(statsKey) || '{}');
if(!stats.best) stats.best = 0; if(!stats.streak) stats.streak = 0; if(!stats.playedDates) stats.playedDates = [];

// DOM refs
const dateLabel = document.getElementById('dateLabel');
const clueChips = document.getElementById('clueChips');
const guessInput = document.getElementById('guessInput');
const suggestList = document.getElementById('suggestList');
const guessBtn = document.getElementById('guessBtn');
const revealBtn = document.getElementById('revealBtn');
const guessesEl = document.getElementById('guesses');
const answerReveal = document.getElementById('answerReveal');
const attemptsStat = document.getElementById('attemptsStat');
const streakStat = document.getElementById('streakStat');
const bestStat = document.getElementById('bestStat');
const progressText = document.getElementById('progressText');
const progressFill = document.getElementById('progressFill');

function initUI(){
  dateLabel.textContent = today.toLocaleDateString('en-GB', {year:'numeric', month:'short', day:'numeric'});
  clueChips.innerHTML = [`<div class="chip slide-in">Organ: ${TARGET.organ}</div>`, `<div class="chip slide-in">Morph: ${TARGET.morph.split('/')[0].trim()}</div>`, `<div class="chip slide-in">Location: ${TARGET.location.split('/')[0].trim()}</div>`].join('');
  updateProgress();
  attemptsStat.textContent = `Attempts: ${attempts}/${MAX}`;
  streakStat.textContent = `Streak: ${stats.streak || 0}`;
  bestStat.textContent = `Best: ${stats.best || 0}`;
}

function updateProgress(){
  const progress = (attempts / MAX) * 100;
  progressFill.style.width = `${progress}%`;
}

function evaluateGuess(item){
  const res = {};
  res.nameMatch = (item.key === TARGET.key);
  res.organ = normalize(item.organ) === normalize(TARGET.organ) ? 'ok' : (normalize(item.organ) && normalize(TARGET.organ).includes(normalize(item.organ)) ? 'partial' : 'no');
  res.malign = (item.malign === TARGET.malign) ? 'ok' : 'no';
  res.morph = normalize(item.morph).split(/[\s\/\\,]+/)[0] === normalize(TARGET.morph).split(/[\s\/\\,]+/)[0] ? 'ok' : (fuzzyMatch(normalize(item.morph), normalize(TARGET.morph)) ? 'partial' : 'no');
  res.color = normalize(item.color) === normalize(TARGET.color) ? 'ok' : (fuzzyMatch(normalize(item.color), normalize(TARGET.color)) ? 'partial' : 'no');
  res.location = normalize(item.location).split(/[\s\/\\,]+/)[0] === normalize(TARGET.location).split(/[\s\/\\,]+/)[0] ? 'ok' : (fuzzyMatch(normalize(item.location), normalize(TARGET.location)) ? 'partial' : 'no');
  res.growth = normalize(item.growth).split(/[\s\/\\,]+/)[0] === normalize(TARGET.growth).split(/[\s\/\\,]+/)[0] ? 'ok' : (fuzzyMatch(normalize(item.growth), normalize(TARGET.growth)) ? 'partial' : 'no');
  res.size = normalize(item.size) === normalize(TARGET.size) ? 'ok' : ( (normalize(item.size).includes('small') && normalize(TARGET.size).includes('medium')) ? 'partial' : 'no');
  res.symptom = normalize(item.symptom).split(/[\s\/\\,]+/)[0] === normalize(TARGET.symptom).split(/[\s\/\\,]+/)[0] ? 'ok' : (fuzzyMatch(normalize(item.symptom), normalize(TARGET.symptom)) ? 'partial' : 'no');
  return res;
}

function renderGuessRow(item, evalRes){
  const row = document.createElement('div'); row.className='guess-card fade-in';
  const name = document.createElement('div'); name.className='guess-name'; name.textContent = item.name;
  row.appendChild(name);

  const badges = document.createElement('div'); badges.className='badges';
  const criteria = [ ['Organ', evalRes.organ], ['Malignancy', evalRes.malign], ['Morph', evalRes.morph], ['Color', evalRes.color], ['Location', evalRes.location], ['Growth', evalRes.growth], ['Size', evalRes.size], ['Symptom', evalRes.symptom] ];
  criteria.forEach(([label, state], index)=>{
    const b = document.createElement('div'); 
    b.className='badge ' + (state==='ok'? 'ok' : (state==='partial'? 'partial' : 'no')); 
    b.textContent = label; 
    b.style.animationDelay = `${index * 0.1}s`;
    badges.appendChild(b);
  });
  row.appendChild(badges);
  guessesEl.prepend(row);
  
  // Add visual feedback
  if(evalRes.nameMatch){
    row.classList.add('success-glow');
    setTimeout(() => row.classList.add('bounce'), 100);
  }
}

function showSuggestions(q){
  const term = normalize(q);
  if(!term){ suggestList.style.display='none'; suggestList.innerHTML=''; return; }
  const exact = ITEMS.filter(it=>normalize(it.name) === term);
  let matches = exact.length? exact : ITEMS.filter(it => fuzzyMatch(term, it.name) || fuzzyMatch(term, it.organ));
  matches = matches.slice(0,12);
  suggestList.innerHTML = '';
  matches.forEach(it=>{
    const div = document.createElement('div'); div.className='suggest-item'; div.textContent = it.name + ' â€” ' + it.organ;
    div.onclick = ()=>{ guessInput.value = it.name; submitGuessByName(it.name); suggestList.style.display='none'; };
    suggestList.appendChild(div);
  });
  suggestList.style.display = matches.length ? 'block' : 'none';
}

function findByName(name){
  const term = normalize(name);
  return ITEMS.find(it => normalize(it.name) === term) || ITEMS.find(it => normalize(it.name).includes(term)) || ITEMS.find(it => normalize(it.name).split(' ')[0] === term);
}

function submitGuessByName(name){
  if(solved) return;
  const item = findByName(name);
  if(!item){ 
    guessInput.classList.add('error-shake');
    setTimeout(() => guessInput.classList.remove('error-shake'), 500);
    alert('No matching lesion found. Try selecting from suggestions.'); 
    return; 
  }
  attempts++;
  attemptsStat.textContent = `Attempts: ${attempts}/${MAX}`;
  updateProgress();
  const ev = evaluateGuess(item);
  renderGuessRow(item, ev);
  guessInput.value = '';
  suggestList.style.display = 'none';
  
  if(ev.nameMatch){ solved=true; onSolved(true); }
  else if(attempts>=MAX){ solved=true; onSolved(false); }
}

function onSolved(correct){
  const todayKey = today.toISOString().slice(0,10);
  if(!stats.playedDates.includes(todayKey)) stats.playedDates.push(todayKey);
  if(correct){ stats.streak = (stats.lastWin === yesterdayString()) ? (stats.streak||0) + 1 : 1; stats.lastWin = today.toISOString().slice(0,10); stats.best = Math.max(stats.best||0, stats.streak||0); }
  else { stats.streak = 0; }
  localStorage.setItem(statsKey, JSON.stringify(stats));
  revealAnswer();
  streakStat.textContent = `Streak: ${stats.streak||0}`;
  bestStat.textContent = `Best: ${stats.best||0}`;
  progressText.textContent = correct ? 'ðŸŽ‰ Nice! You solved today\'s puzzle.' : 'Keep practicing â€” try again tomorrow.';
  
  // Add visual celebration
  if(correct){
    document.querySelector('.game').classList.add('success-glow');
    setTimeout(() => document.querySelector('.game').classList.remove('success-glow'), 2000);
  }
  
  setTimeout(()=>{ alert(correct? 'ðŸŽ‰ Correct â€” well done!':'Out of attempts â€” answer revealed.'); },50);
}

function yesterdayString(){ const d = new Date(today); d.setDate(d.getDate()-1); return d.toISOString().slice(0,10); }

function revealAnswer(){
  answerReveal.innerHTML = `<strong>${TARGET.name}</strong><div style="margin-top:8px;color:var(--muted)">Organ: ${TARGET.organ} â€¢ Malignancy: ${TARGET.malign? 'Malignant':'Benign'} â€¢ Morphology: ${TARGET.morph} â€¢ Color: ${TARGET.color} â€¢ Location: ${TARGET.location} â€¢ Growth: ${TARGET.growth} â€¢ Size: ${TARGET.size} â€¢ Symptom: ${TARGET.symptom}</div><div style="margin-top:8px;color:var(--muted)">${TARGET.note}</div>`;
}

// handlers
guessInput.addEventListener('input',(e)=>{ showSuggestions(e.target.value); });
guessInput.addEventListener('keydown',(e)=>{ if(e.key === 'Enter'){ submitGuessByName(guessInput.value); suggestList.style.display='none'; }});
guessBtn.addEventListener('click', ()=>{ submitGuessByName(guessInput.value); });
revealBtn.addEventListener('click', ()=>{ revealAnswer(); solved=true; });

// init
initUI();

</script>

<script>
// lightweight noise generator for subtle texture
(function(){
  const canvas = document.getElementById('noiseCanvas');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  function resize(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
  function frame(){
    const w = canvas.width, h = canvas.height;
    const imgData = ctx.createImageData(w, h);
    const data = imgData.data;
    for(let i=0;i<data.length;i+=4){
      const v = (Math.random()*255)|0; // random grayscale
      data[i]=v; data[i+1]=v; data[i+2]=v; data[i+3]=20; // low alpha
    }
    ctx.putImageData(imgData,0,0);
  }
  resize(); frame();
  let raf; function loop(){ frame(); raf = requestAnimationFrame(loop); }
  loop();
  window.addEventListener('resize',()=>{ resize(); });
})();

// Helper to let you set a custom background easily
(function(){
  const bg = document.getElementById('userBg');
  const bgUrl = window.localStorage.getItem('endodle_custom_bg_url');
  if(!bg) return;
  // default to assets/bg.jpg if present
  bg.style.backgroundImage = "url('assets/bg.jpg')";
  bg.style.display = 'block';
  // if a custom URL is set, prefer it
  if(bgUrl){ bg.style.backgroundImage = `url('${bgUrl}')`; }
})();
</script>
</body>
</html>
