<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Endo-Sim: Resident Training</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;700&display=swap');

        /* --- TEMEL AYARLAR --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            margin: 0; overflow: hidden; background: #000; 
            font-family: 'Chakra Petch', sans-serif; 
            user-select: none; touch-action: none;
        }
        canvas { display: block; width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 1; }

        /* --- Sƒ∞NEMATƒ∞K KATMANLAR (Tƒ±klamayƒ± engellememeli) --- */
        #vignette {
            position: absolute; top:0; left:0; width:100%; height:100%; pointer-events: none; z-index: 5;
            background: radial-gradient(circle, transparent 60%, #000 95%);
        }
        #scanlines {
            position: absolute; top:0; left:0; width:100%; height:100%; pointer-events: none; z-index: 6;
            background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.2) 3px);
            opacity: 0.5;
        }

        /* --- MEN√ú (En √úst Katman) --- */
        #menu-layer {
            position: absolute; top:0; left:0; width:100%; height:100%; z-index: 9999;
            background: linear-gradient(135deg, #050505 0%, #1a0a0a 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .logo-box { 
            border: 2px solid #00ffcc; padding: 20px 40px; margin-bottom: 40px; 
            text-align: center; box-shadow: 0 0 30px rgba(0,255,204,0.2); background: rgba(0,0,0,0.8);
        }
        .title { font-size: 32px; color: #00ffcc; font-weight: 800; letter-spacing: 4px; margin: 0; }
        .subtitle { font-size: 14px; color: #88a; letter-spacing: 1px; margin-top: 5px; }
        
        .level-btn {
            width: 300px; padding: 15px; margin: 10px; background: rgba(255,255,255,0.05);
            border: 1px solid #444; color: white; cursor: pointer; text-align: left;
            transition: 0.2s; position: relative; overflow: hidden;
        }
        .level-btn:hover { border-color: #00ffcc; background: rgba(0,255,204,0.1); transform: scale(1.02); }
        .lvl-name { font-weight: bold; font-size: 16px; color: #fff; }
        .lvl-desc { font-size: 12px; color: #aaa; margin-top: 3px; }
        .lvl-badge { position: absolute; right: 10px; top: 15px; font-size: 10px; background: #333; padding: 2px 6px; border-radius: 4px; }

        /* --- OYUN ARAY√úZ√ú (HUD) --- */
        #game-ui { display: none; width: 100%; height: 100%; position: absolute; top:0; left:0; z-index: 500; pointer-events: none; }
        
        .hud-panel {
            position: absolute; background: rgba(0, 10, 15, 0.8); border: 1px solid #00ffcc;
            padding: 10px 15px; border-radius: 8px; color: white; pointer-events: none;
        }
        .top-left { top: 20px; left: 20px; border-left: 4px solid #00ffcc; }
        .top-right { top: 20px; right: 20px; text-align: right; border-right: 4px solid #ff3333; }
        
        .hud-val { font-size: 20px; font-weight: bold; color: #fff; }
        .hud-lbl { font-size: 10px; color: #00ffcc; letter-spacing: 1px; }

        /* --- ARA√á √áUBUƒûU --- */
        #toolbar {
            position: absolute; bottom: 30px; right: 20px; display: flex; flex-direction: column; gap: 15px;
            pointer-events: auto; /* Tƒ±klanabilir */
        }
        .tool-btn {
            width: 70px; height: 70px; background: rgba(0,0,0,0.8); border: 2px solid #444; border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #888; transition: 0.2s; cursor: pointer;
        }
        .tool-btn.active { border-color: #00ffcc; color: #00ffcc; box-shadow: 0 0 15px rgba(0,255,204,0.3); }
        .tool-icon { font-size: 24px; margin-bottom: 2px; }
        .tool-name { font-size: 9px; font-weight: bold; }

        /* --- AKSƒ∞YON BUTONU --- */
        #action-btn {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            width: 90px; height: 90px; border-radius: 50%; background: rgba(0, 255, 204, 0.1);
            border: 2px solid #00ffcc; color: #00ffcc; font-weight: bold; font-size: 14px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            pointer-events: auto; backdrop-filter: blur(4px); transition: 0.1s;
        }
        #action-btn:active { background: #00ffcc; color: #000; transform: translateX(-50%) scale(0.95); }
        #action-btn.disabled { opacity: 0.3; pointer-events: none; border-color: #555; color: #555; }

        /* --- JOYSTICKLER --- */
        #controls-wrapper {
            position: absolute; bottom: 140px; width: 100%; display: flex; justify-content: space-between; 
            padding: 0 40px; pointer-events: none;
        }
        .stick-zone {
            width: 120px; height: 120px; background: rgba(255,255,255,0.05); border: 1px dashed rgba(255,255,255,0.2);
            border-radius: 50%; display: flex; align-items: center; justify-content: center; pointer-events: auto;
            position: relative;
        }
        .stick-knob {
            width: 50px; height: 50px; background: rgba(0, 255, 204, 0.5); border-radius: 50%;
            position: absolute; box-shadow: 0 0 10px #00ffcc; pointer-events: none; transform: translate(0,0);
        }
        .stick-lbl { position: absolute; bottom: -20px; width: 100%; text-align: center; color: #aaa; font-size: 10px; }

        /* --- BILDIRIM --- */
        #notification {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9); border: 1px solid #fff; color: #fff; padding: 15px 30px;
            border-radius: 30px; font-size: 18px; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 999;
        }

        /* --- HATA EKRANI (DEBUG) --- */
        #debug-log {
            display: none; position: absolute; top:0; left:0; width:100%; height:100%; background: #300; 
            color: #fcc; padding: 20px; z-index: 10000; font-family: monospace; white-space: pre-wrap;
        }
    </style>
</head>
<body>

    <div id="debug-log"></div>

    <div id="vignette"></div>
    <div id="scanlines"></div>

    <div id="menu-layer">
        <div class="logo-box">
            <h1 class="title">ENDO-SIM</h1>
            <div class="subtitle">CERRAHƒ∞ Eƒûƒ∞Tƒ∞M PLATFORMU</div>
        </div>

        <div class="level-btn" onclick="App.loadLevel(0)">
            <div class="lvl-name">1. TEMEL NAVƒ∞GASYON</div>
            <div class="lvl-desc">L√ºmen takibi ve ang√ºlasyon pratiƒüi.</div>
            <div class="lvl-badge" style="background:#00aaff">KOLAY</div>
        </div>

        <div class="level-btn" onclick="App.loadLevel(1)">
            <div class="lvl-name">2. POLƒ∞PEKTOMƒ∞</div>
            <div class="lvl-desc">Snare kullanarak polip rezeksiyonu.</div>
            <div class="lvl-badge" style="background:#ffaa00">ORTA</div>
        </div>

        <div class="level-btn" onclick="App.loadLevel(2)">
            <div class="lvl-name">3. √úLSER VE KANAMA</div>
            <div class="lvl-desc">Biyopsi alma ve APC ile daƒülama.</div>
            <div class="lvl-badge" style="background:#ff3333">ZOR</div>
        </div>
    </div>

    <div id="game-ui">
        <div class="hud-panel top-left">
            <div class="hud-lbl">VAKA</div>
            <div class="hud-val" id="case-name-txt">NAVƒ∞GASYON</div>
            <div class="hud-lbl" style="margin-top:5px;">DERƒ∞NLƒ∞K</div>
            <div class="hud-val"><span id="depth-txt">0</span> cm</div>
        </div>

        <div class="hud-panel top-right">
            <div class="hud-lbl">G√ñREV</div>
            <div class="hud-val" id="score-txt">0/1</div>
            <div class="hud-lbl" style="margin-top:5px;">DURUM</div>
            <div class="hud-val" id="status-txt" style="color:#0f0">STABƒ∞L</div>
        </div>

        <div id="controls-wrapper">
            <div class="stick-zone" id="joy-left">
                <div class="stick-knob"></div>
                <div class="stick-lbl">ANG√úLASYON</div>
            </div>
            <div class="stick-zone" id="joy-right">
                <div class="stick-knob"></div>
                <div class="stick-lbl">ƒ∞LERLEME / TORK</div>
            </div>
        </div>

        <div id="action-btn" class="disabled" onmousedown="App.actionStart()" onmouseup="App.actionEnd()" ontouchstart="App.actionStart()" ontouchend="App.actionEnd()">
            ---
        </div>

        <div id="toolbar">
            <div class="tool-btn active" id="btn-nav" onclick="App.setTool('nav')">
                <span class="tool-icon">üëÅÔ∏è</span>
                <span class="tool-name">NAV</span>
            </div>
            <div class="tool-btn" id="btn-photo" onclick="App.takePhoto()">
                <span class="tool-icon">üì∏</span>
                <span class="tool-name">FOTO</span>
            </div>
            <div class="tool-btn" id="btn-snare" onclick="App.setTool('snare')">
                <span class="tool-icon">‚≠ï</span>
                <span class="tool-name">SNARE</span>
            </div>
            <div class="tool-btn" id="btn-biopsy" onclick="App.setTool('biopsy')">
                <span class="tool-icon">ü•¢</span>
                <span class="tool-name">Bƒ∞YOPSƒ∞</span>
            </div>
        </div>

        <div id="notification">MESAJ</div>
    </div>

    <script>
        // --- HATA YAKALAYICI (DEBUG) ---
        window.onerror = function(msg, url, line) {
            const log = document.getElementById('debug-log');
            log.style.display = 'block';
            log.innerHTML += `HATA: ${msg}\nSatƒ±r: ${line}\n\n`;
            return false;
        };

        // --- UYGULAMA (APP) ---
        const CONF = {
            TUBE_LEN: 600,
            TUBE_RAD: 7,
            MOVE_SPEED: 0.08, 
            ROT_SPEED: 0.04
        };

        // Deƒüi≈ükenler
        let scene, camera, renderer, tubeCurve;
        let snareGroup, forcepsGroup;
        let polyps = [];
        
        const state = {
            active: false,
            pos: 0.005,
            velocity: 0,
            look: { x:0, y:0 },
            torque: 0,
            tool: 'nav',
            actionPhase: 0,
            score: 0,
            targetScore: 1
        };

        const input = { left: {x:0,y:0}, right: {x:0,y:0} };

        // Global App Nesnesi
        window.App = {
            loadLevel: function(id) {
                document.getElementById('menu-layer').style.display = 'none';
                document.getElementById('game-ui').style.display = 'block';
                
                let caseName = "NAVƒ∞GASYON";
                if(id===1) caseName = "POLƒ∞PEKTOMƒ∞";
                if(id===2) caseName = "√úLSER TANISI";
                document.getElementById('case-name-txt').innerText = caseName;

                init3D(id);
                state.active = true;
                notify("VAKA BA≈ûLADI - L√úMENƒ∞ TAKƒ∞P ET");
            },

            setTool: function(name) {
                state.tool = name;
                state.actionPhase = 0;
                
                // UI
                document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('btn-'+name).classList.add('active');

                // G√∂rsel
                if(snareGroup) snareGroup.visible = (name === 'snare');
                if(forcepsGroup) forcepsGroup.visible = (name === 'biopsy');

                // Buton
                const btn = document.getElementById('action-btn');
                if(name === 'nav' || name === 'photo') {
                    btn.classList.add('disabled');
                    btn.innerText = "---";
                } else {
                    btn.classList.remove('disabled');
                    btn.innerText = name === 'biopsy' ? 'AL' : 'A√á';
                }
                notify(name.toUpperCase() + " MODU");
            },

            takePhoto: function() {
                const flash = document.createElement('div');
                flash.style.cssText = "position:absolute;top:0;left:0;width:100%;height:100%;background:white;z-index:999;opacity:0.8;transition:opacity 0.2s;pointer-events:none;";
                document.body.appendChild(flash);
                setTimeout(() => flash.style.opacity = 0, 50);
                setTimeout(() => flash.remove(), 250);
                
                // Puan kontrol√º (Basit)
                let found = false;
                const camPos = camera.position;
                polyps.forEach(p => {
                    if(p.visible && camPos.distanceTo(p.position) < 30) found = true;
                });
                
                if(found) notify("PATOLOJƒ∞ KAYDEDƒ∞LDƒ∞", "#0f0");
                else notify("G√ñR√úNT√ú ALINDI");
            },

            actionStart: function() {
                if(state.tool === 'nav') return;
                
                if(state.tool === 'snare') {
                    if(state.actionPhase === 0) { // A√ß
                        new TWEEN.Tween(snareGroup.children[1].scale).to({x:1, y:1}, 500).start();
                        state.actionPhase = 1;
                        document.getElementById('action-btn').innerText = "KES";
                    } else if(state.actionPhase === 1) { // Kes
                        new TWEEN.Tween(snareGroup.children[1].scale).to({x:0.1, y:0.1}, 200).start();
                        checkInteraction();
                        setTimeout(() => {
                            state.actionPhase = 0;
                            document.getElementById('action-btn').innerText = "A√á";
                        }, 500);
                    }
                }
                else if(state.tool === 'biopsy') {
                    // Kapat
                    new TWEEN.Tween(forcepsGroup.children[1].rotation).to({x: -Math.PI/2}, 200).start();
                    new TWEEN.Tween(forcepsGroup.children[2].rotation).to({x: Math.PI/2}, 200).start();
                    checkInteraction();
                }
            },

            actionEnd: function() {
                if(state.tool === 'biopsy') {
                    // A√ß (Bƒ±rakƒ±nca)
                    new TWEEN.Tween(forcepsGroup.children[1].rotation).to({x: -Math.PI/2 + 0.5}, 200).start();
                    new TWEEN.Tween(forcepsGroup.children[2].rotation).to({x: Math.PI/2 - 0.5}, 200).start();
                }
            }
        };

        function notify(msg, color="#fff") {
            const el = document.getElementById('notification');
            el.innerText = msg;
            el.style.color = color;
            el.style.opacity = 1;
            setTimeout(() => el.style.opacity = 0, 2000);
        }

        // --- 3D ENGINE ---
        function init3D(levelId) {
            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, logarithmicDepthBuffer: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            // I≈üƒ±k sorununu √ß√∂zmek i√ßin ToneMapping'i kapattƒ±m veya basitle≈ütirdim
            // renderer.toneMapping = THREE.ReinhardToneMapping; 
            document.body.appendChild(renderer.domElement);

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050000);
            scene.fog = new THREE.FogExp2(0x050000, 0.02);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            scene.add(camera);

            // I≈üƒ±klandƒ±rma (Daha g√º√ßl√º ve basit)
            const spot = new THREE.SpotLight(0xffeebb, 1.5, 80, 0.5, 0.5);
            spot.position.set(0,0,0);
            camera.add(spot);
            
            const ambient = new THREE.AmbientLight(0x401010, 0.6); // Ortam ƒ±≈üƒ±ƒüƒ±nƒ± artƒ±rdƒ±m
            scene.add(ambient);

            // ƒ∞√ßerik
            createColon();
            createTools();
            
            if(levelId === 1) createPolyp(-200, 'polyp');
            if(levelId === 2) createPolyp(-300, 'ulcer');

            setupJoystick('joy-left', input.look);
            setupJoystick('joy-right', input.move);

            animate();
        }

        function createColon() {
            const points = [];
            for(let i=0; i<150; i++) {
                const x = Math.sin(i*0.2)*25 + Math.cos(i*0.5)*10;
                const y = Math.cos(i*0.3)*20;
                const z = i * -6;
                points.push(new THREE.Vector3(x,y,z));
            }
            tubeCurve = new THREE.CatmullRomCurve3(points);
            
            const geo = new THREE.TubeGeometry(tubeCurve, 300, CONF.TUBE_RAD, 20, false);
            // Haustra Noise
            const pos = geo.attributes.position;
            for(let i=0; i<pos.count; i++) {
                const z = pos.getZ(i);
                const r = 1 + Math.sin(z*0.3)*0.15 + Math.random()*0.02;
                pos.setX(i, pos.getX(i)*r);
                pos.setY(i, pos.getY(i)*r);
            }
            geo.computeVertexNormals();

            // Mukoza (Canvas Texture - G√ºvenli)
            const cvs = document.createElement('canvas'); cvs.width=512; cvs.height=512;
            const ctx = cvs.getContext('2d');
            ctx.fillStyle='#b05050'; ctx.fillRect(0,0,512,512);
            ctx.strokeStyle='rgba(80,0,0,0.2)'; ctx.lineWidth=3;
            for(let i=0; i<150; i++){
                ctx.beginPath(); ctx.moveTo(Math.random()*512, Math.random()*512);
                ctx.bezierCurveTo(Math.random()*512,Math.random()*512,Math.random()*512,Math.random()*512,Math.random()*512,Math.random()*512);
                ctx.stroke();
            }
            const tex = new THREE.CanvasTexture(cvs);
            tex.wrapS = tex.wrapT = THREE.RepeatWrapping; tex.repeat.set(20,4);

            // MeshPhongMaterial (En g√ºvenli materyal)
            const mat = new THREE.MeshPhongMaterial({
                map: tex, color: 0xffcccc, specular: 0x222222, shininess: 30, side: THREE.BackSide, bumpMap: tex, bumpScale: 0.1
            });
            const mesh = new THREE.Mesh(geo, mat);
            scene.add(mesh);
        }

        function createPolyp(zPos, type) {
            const t = Math.abs(zPos) / (150*6);
            const pt = tubeCurve.getPointAt(t);
            const tan = tubeCurve.getTangentAt(t);
            const norm = new THREE.Vector3(1,0,0).applyAxisAngle(tan, Math.random()*Math.PI*2);
            const pos = pt.clone().add(norm.multiplyScalar(CONF.TUBE_RAD * 0.8));

            let mesh;
            if(type === 'polyp') {
                const geo = new THREE.SphereGeometry(2.5, 32, 32);
                const mat = new THREE.MeshPhongMaterial({ color: 0xff4444, shininess: 40 });
                mesh = new THREE.Mesh(geo, mat);
            } else { // Ulcer
                const geo = new THREE.CircleGeometry(3, 32);
                const mat = new THREE.MeshBasicMaterial({ color: 0xffffff, side: THREE.DoubleSide });
                mesh = new THREE.Mesh(geo, mat);
                mesh.lookAt(pt);
            }
            
            mesh.position.copy(pos);
            mesh.userData = { type: type, active: true };
            scene.add(mesh);
            polyps.push(mesh);
        }

        function createTools() {
            const offset = new THREE.Vector3(2, -2, -8);

            // Snare
            snareGroup = new THREE.Group();
            const line = new THREE.Mesh(new THREE.CylinderGeometry(0.05,0.05,5), new THREE.MeshBasicMaterial({color:0x888888}));
            line.rotation.x = Math.PI/2; line.position.z = -2.5;
            const loop = new THREE.Mesh(new THREE.TorusGeometry(1.5, 0.05, 16, 32), new THREE.MeshBasicMaterial({color:0x00aaff}));
            loop.position.z = -5; loop.scale.set(0,0,0);
            snareGroup.add(line); snareGroup.add(loop);
            snareGroup.position.copy(offset); snareGroup.visible = false;
            camera.add(snareGroup);

            // Biopsy
            forcepsGroup = new THREE.Group();
            const sheath = new THREE.Mesh(new THREE.CylinderGeometry(0.1,0.1,5), new THREE.MeshBasicMaterial({color:0xaaaaaa}));
            sheath.rotation.x = Math.PI/2; sheath.position.z = -2.5;
            const cupGeo = new THREE.SphereGeometry(0.3, 16, 16, 0, Math.PI);
            const cupMat = new THREE.MeshBasicMaterial({color:0x888888});
            const cup1 = new THREE.Mesh(cupGeo, cupMat); cup1.position.set(0,0.1,-5); cup1.rotation.set(-Math.PI/2+0.5,0,0);
            const cup2 = new THREE.Mesh(cupGeo, cupMat); cup2.position.set(0,-0.1,-5); cup2.rotation.set(Math.PI/2-0.5,0,0);
            forcepsGroup.add(sheath); forcepsGroup.add(cup1); forcepsGroup.add(cup2);
            forcepsGroup.position.copy(offset); forcepsGroup.visible = false;
            camera.add(forcepsGroup);
        }

        function updateToolVisuals() {
            if(!snareGroup) return;
            snareGroup.visible = (state.tool === 'snare');
            forcepsGroup.visible = (state.tool === 'biopsy');
        }

        function animate(time) {
            requestAnimationFrame(animate);
            TWEEN.update(time);

            if(!state.active) return;

            // Hareket (Saƒü Stick Y)
            const targetSpeed = -input.right.y * CONF.MOVE_SPEED; 
            state.velocity += (targetSpeed - state.velocity) * 0.1; 
            state.pos += state.velocity * 0.01;
            if(state.pos < 0) state.pos = 0; if(state.pos>0.99) state.pos=0.99;

            // Kamera
            const pt = tubeCurve.getPointAt(state.pos);
            const lookAtPt = tubeCurve.getPointAt(Math.min(state.pos + 0.01, 0.99));
            camera.position.copy(pt);
            camera.lookAt(lookAtPt);

            // Manevra
            state.torque += (input.right.x - state.torque) * 0.1;
            state.look.x += (input.left.x - state.look.x) * 0.1;
            state.look.y += (input.left.y - state.look.y) * 0.1;

            camera.rotateZ(-state.torque * 1.5);
            camera.rotateY(-state.look.x * 1.5); 
            camera.rotateX(-state.look.y * 1.5); 

            // UI
            document.getElementById('depth-txt').innerText = Math.floor(state.pos * 600);

            renderer.render(scene, camera);
        }

        function checkInteraction() {
            const toolPos = new THREE.Vector3(0,0,-8).applyQuaternion(camera.quaternion).add(camera.position);
            let hit = false;
            
            polyps.forEach(p => {
                if(p.visible && p.position.distanceTo(toolPos) < 5) {
                    if(state.tool === 'snare' && p.userData.type === 'polyp') {
                        p.visible = false;
                        notify("POLƒ∞P REZEKE EDƒ∞LDƒ∞", "#0f0");
                        hit = true;
                        state.score++;
                        document.getElementById('score-txt').innerText = state.score + "/1";
                    }
                    else if(state.tool === 'biopsy' && p.userData.type === 'ulcer') {
                        notify("Bƒ∞YOPSƒ∞ ALINDI", "#0f0");
                        hit = true;
                        state.score++;
                        document.getElementById('score-txt').innerText = state.score + "/1";
                    }
                    else {
                        notify("YANLI≈û ALET / HEDEF", "#ffaa00");
                        hit = true;
                    }
                }
            });

            if(!hit) notify("BO≈û ƒ∞≈ûLEM");
        }

        function setupJoystick(elmId, outObj) {
            const base = document.getElementById(elmId);
            const handle = base.querySelector('.stick-knob');
            let startX, startY, active=false; const max=40;

            const handleStart = (cx, cy) => { active=true; startX=cx; startY=cy; };
            const handleMove = (cx, cy) => {
                if(!active) return;
                const dx = cx - startX, dy = cy - startY;
                const dist = Math.min(Math.sqrt(dx*dx+dy*dy), max);
                const angle = Math.atan2(dy, dx);
                const fx = Math.cos(angle)*dist, fy = Math.sin(angle)*dist;
                handle.style.transform = `translate(${fx}px, ${fy}px)`;
                outObj.x = fx/max; outObj.y = fy/max;
            };
            const handleEnd = () => { active=false; handle.style.transform=`translate(0,0)`; outObj.x=0; outObj.y=0; };

            base.addEventListener('mousedown', e => handleStart(e.clientX, e.clientY));
            window.addEventListener('mousemove', e => handleMove(e.clientX, e.clientY));
            window.addEventListener('mouseup', handleEnd);
            
            base.addEventListener('touchstart', e => { e.preventDefault(); handleStart(e.touches[0].clientX, e.touches[0].clientY); }, {passive:false});
            window.addEventListener('touchmove', e => { e.preventDefault(); handleMove(e.touches[0].clientX, e.touches[0].clientY); }, {passive:false});
            window.addEventListener('touchend', handleEnd);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>
